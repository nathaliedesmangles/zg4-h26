+++
pre = 'Semaine 14 : '
title = 'Archivage & compression'
weight = 140
+++



### Objectif de la semaine : 

* CrÃ©er une stratÃ©gie de sauvegarde complÃ¨te et automatisÃ©e utilisant `tar` et le scripting Bash.

### Plan de la sÃ©ance #1

1. Archiver vs compresser : Quelle diffÃ©rence ? (30 min)  
2. La commande `tar` (45 min)  
3. La rÃ¨gle du 3-2-1 (30 min)  
4. Bonnes pratiques de scripting (15 min)

ðŸ›‘ **Exercice (en classe)**: "Le DÃ©samorÃ§age" (10 min)

### Plan de la sÃ©ance #2

**Laboratoire :** Construire un script intÃ©grateur qui servira de rÃ©vision pour l'examen final.

---

# THÃ‰ORIE

*Â« Il existe deux types de personnes : ceux qui ont dÃ©jÃ  perdu des donnÃ©es, et ceux qui vont en perdre. Aujourd'hui, on s'assure que vous restiez dans la deuxiÃ¨me catÃ©gorie le plus longtemps possible. Â»*

### 14.1 Archiver vs compresser : Quelle diffÃ©rence ?

Sous Windows, "Zipper" fait les deux en mÃªme temps. Sous Linux, ce sont deux Ã©tapes distinctes .

1. **Archiver (`tar` - Tape ARchiver) :**
* Prendre 1000 fichiers Ã©parpillÃ©s et les mettre dans une seule "boÃ®te" (un seul fichier `.tar`).
* *Analogie :* Mettre ses livres dans un carton de dÃ©mÃ©nagement. Le poids est le mÃªme.


2. **Compresser (`gzip`, `bzip2`) :**
* Prendre un fichier et rÃ©duire sa taille mathÃ©matiquement.
* *Analogie :* Aspirer l'air d'un sac sous vide. Ã‡a prend moins de place.


3. **Le combo (`.tar.gz`) :**
* On met dans la boÃ®te (`tar`), PUIS on aspire l'air (`gzip`).



### 14.2 La commande `tar`

C'est la commande la plus redoutÃ©e pour sa syntaxe, mais on va la simplifier .

* **CrÃ©er une archive :** `tar -czf nom.tar.gz dossier/`
* `-c` : **C**reate (CrÃ©er).
* `-z` : G**z**ip (Compresser).
* `-f` : **F**ile (Nom du fichier - DOIT Ãªtre le dernier flag !).


* **Extraire une archive :** `tar -xzf archive.tar.gz`
* `-x` : E**x**tract (Extraire).


* **Lister le contenu (sans extraire) :** `tar -tf archive.tar.gz`
* `-t` : lis**T**.



### 14.3 La rÃ¨gle du 3-2-1

Une sauvegarde sur le mÃªme disque dur que l'original n'est **pas** une sauvegarde.

* **3** copies de vos donnÃ©es.
* **2** supports diffÃ©rents (Disque dur interne + ClÃ© USB/NAS).
* **1** copie hors-site (Cloud ou chez grand-maman - contre le feu/vol).

### 14.4 Bonnes pratiques de scripting

Pour le projet d'aujourd'hui, on rÃ©vise :

* **Nommage dynamique :** `backup_$(date +%F).tar.gz` pour ne pas Ã©craser la sauvegarde d'hier.
* **VÃ©rification de succÃ¨s :** Utiliser `$?` (code de retour). Si `tar` plante, on ne veut pas afficher "SuccÃ¨s".

---

### ðŸ›‘ **Exercice (en classe)**: "Le DÃ©samorÃ§age" (10 min)

*Au tableau :*
`tar -cfz backup.tar.gz mon_dossier`

**Question :** Pourquoi cette commande va-t-elle planter ou crÃ©er un fichier bizarre ?
**RÃ©ponse :** L'option `-f` attend **immÃ©diatement** un nom de fichier aprÃ¨s elle. Ici, `tar` va penser que l'archive s'appelle `z` et que `backup.tar.gz` est un dossier Ã  inclure.
**Correction :** Toujours mettre `f` Ã  la fin des options -> `-czf`.


### ðŸ’¡ Astuces de la semaine

*DerniÃ¨re astuce vitale pour Ã©viter le dÃ©sordre.*

> **ATTENTION Ã€ LA "TARBOMB" (Bombe TAR)**
> Quand vous crÃ©ez une archive, **archivez toujours un dossier**, pas une liste de fichiers en vrac.
> * âŒ **Mauvais :** `tar -czf backup.tar.gz fichier1 fichier2 fichier3 ...`
> * *Pourquoi ?* Quand quelqu'un va extraire Ã§a sur son bureau, 1000 fichiers vont exploser partout mÃ©langÃ©s Ã  ses icÃ´nes.
> 
> * âœ… **Bon :** `tar -czf backup.tar.gz MonDossier/`
> * *Pourquoi ?* Ã€ l'extraction, un seul dossier propre apparaÃ®t contenant les fichiers.
> 
> **MnÃ©monique TAR :**
> **C**'est **Z**uper **F**acile (`-czf` pour CrÃ©er)
> e**X**trait **Z**e **F**ile (`-xzf` pour Extraire)


---

# LABORATOIRE - PROJET INTÃ‰GRATEUR

**Objectif :** Construire le script ultime qui servira de rÃ©vision pour l'examen final.

### Ã‰tape 0 : PrÃ©paration des donnÃ©es (15 min)

1. CrÃ©ez un dossier `~/Projet_Backup`.
2. CrÃ©ez un sous-dossier `Donnees_Critiques`.
3. Remplissez-le avec quelques fichiers bidons (`touch rapport{1..5}.txt`).
4. CrÃ©ez un dossier pour recevoir les backups : `~/Archives`.

### Ã‰tape 1 : Le script V1 - "Le stagiaire" (30 min)

*Faire une version simple qui marche.*

1. CrÃ©ez `backup.sh`.
2. Le script doit simplement crÃ©er une archive de `Donnees_critiques` vers `~/Archives/backup.tar.gz`.
3. Testez-le. VÃ©rifiez que le fichier `.tar.gz` est bien crÃ©Ã©.
4. Testez l'extraction : allez dans `/tmp`, copiez l'archive et faites `tar -xzf`.

### Ã‰tape 2 : Le script V2 - "Le professionnel" (Variables & dates) (30 min)

*ProblÃ¨me de la V1 : Chaque backup Ã©crase le prÃ©cÃ©dent.*

1. Ajoutez une variable `DATE=$(date +%Y-%m-%d_%H-%M)`.
2. Ajoutez une variable `SOURCE="$HOME/Projet_Backup/Donnees_critiques"`.
3. Ajoutez une variable `DEST="$HOME/Archives"`.
4. Modifiez la commande `tar` pour que le fichier s'appelle `backup_$DATE.tar.gz`.
5. Lancez le script 2 fois Ã  1 minute d'intervalle. Vous devriez avoir 2 fichiers distincts.

### Ã‰tape 3 : Le script V3 - "L'expert" (Conditions & logs) (45 min)

*On ajoute de l'intelligence et de la surveillance.*

1. Le script doit Ã©crire dans un journal : `LOGfile="$HOME/backup.log"`.
2. AprÃ¨s la commande `tar`, ajoutez une condition :
```bash
if [ $? -eq 0 ]; then
    echo "[$DATE] SUCCÃˆS : Sauvegarde de $SOURCE rÃ©ussie." >> $LOGfile
else
    echo "[$DATE] ERREUR : La sauvegarde a Ã©chouÃ© !" >> $LOGfile
    # Optionnel : exit 1
fi
```
3. **Simulation d'erreur :** Modifiez la variable `SOURCE` pour mettre un dossier qui n'existe pas. Lancez le script. VÃ©rifiez le fichier `backup.log`. Il doit crier "ERREUR".

### Ã‰tape 4 : DÃ©fi final

Ajoutez une ligne au script pour supprimer automatiquement les archives vieilles de plus de 7 jours dans le dossier de destination (Utilisez `find ... -mtime ... -delete`).